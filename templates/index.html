<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PrepPal ‚Äî Exam Preparation Chatbot</title>
<style>
:root{
  --bg-gradient: linear-gradient(135deg,#0f172a,#1e293b);
  --container-bg: rgba(30,41,59,0.85);
  --text-color: #f8fafc;
  --muted: #94a3b8;
  --user-bubble: linear-gradient(135deg,#fbbf24,#f59e0b);
  --bot-bubble: linear-gradient(135deg,#14b8a6,#0ea5e9);
  --accent: linear-gradient(135deg,#6366f1,#8b5cf6);
  --accent-hover: linear-gradient(135deg,#4f46e5,#7c3aed);
  --document-badge: #dbeafe;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  background:var(--bg-gradient);
  color:var(--text-color);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:24px;
}
.chat-container{
  width:100%;
  max-width:980px;
  height:86vh;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 20px 60px rgba(2,6,23,0.6);
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  display:flex;
  flex-direction:column;
  position:relative;
}
/* header */
.chat-header{
  background:linear-gradient(135deg,rgba(99,102,241,0.95),rgba(124,58,237,0.95));
  color:white;
  padding:28px 32px;
  text-align:center;
  position:relative;
}
.chat-header h1{font-size:28px;letter-spacing:0.2px;margin-bottom:6px}
.chat-header p{opacity:0.95;font-size:14px}
.status{
  position:absolute;right:20px;top:22px;display:flex;align-items:center;gap:8px;
}
.status-dot{width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.6)}
.status-text{font-size:13px;color:rgba(255,255,255,0.9)}

/* messages */
.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:28px;
  display:flex;
  flex-direction:column;
  gap:18px;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
}
.message{max-width:78%;padding:14px 18px;border-radius:14px;line-height:1.5;font-weight:500;box-shadow:0 8px 20px rgba(0,0,0,0.08)}
.message .meta{font-size:12px;opacity:0.75;margin-top:10px}

/* user / bot alignment */
.message.user{align-self:flex-end;background:var(--user-bubble);color:#111;border-bottom-right-radius:6px}
.message.bot{align-self:flex-start;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9));color:#0b1220;border-bottom-left-radius:6px}
.document-badge{display:inline-flex;align-items:center;gap:8px;margin-top:10px;padding:6px 10px;border-radius:8px;background:var(--document-badge);color:#0b1220;font-weight:600;font-size:13px}

/* quick actions in welcome or top-right overlay */
.quick-actions{display:flex;gap:10px;flex-wrap:wrap}
.quick-action{
  background:rgba(255,255,255,0.06);padding:10px 14px;border-radius:12px;color:var(--text-color);
  border:1px solid rgba(255,255,255,0.04);cursor:pointer;font-weight:600;font-size:13px;
}
.quick-action:hover{transform:translateY(-3px);box-shadow:0 10px 30px rgba(99,102,241,0.12)}

/* input area */
.chat-input-container{padding:20px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:flex-end;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01))}
.file-upload-btn{background:var(--accent);border-radius:14px;padding:12px 14px;border:none;color:#fff;cursor:pointer;box-shadow:0 8px 24px rgba(99,102,241,0.14)}
.chat-input{flex:1;padding:14px 18px;border-radius:18px;border:2px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.92);min-height:48px;resize:none;font-weight:600}
.send-btn{background:var(--accent);border:none;padding:12px 14px;border-radius:12px;color:#fff;cursor:pointer;font-weight:700;box-shadow:0 8px 24px rgba(99,102,241,0.14)}

/* file preview */
.file-preview{display:none;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,0.95);border:1px solid rgba(0,0,0,0.04);margin-bottom:8px}

/* small screens */
@media (max-width:820px){
  .chat-container{width:100%;height:95vh}
  .message{max-width:95%}
}
</style>
</head>
<body>
  <div class="chat-container" role="main">
    <div class="chat-header">
      <div class="status" aria-hidden>
        <div class="status-dot" id="statusDot"></div>
        <div class="status-text" id="statusText">Checking...</div>
      </div>
      <h1>‚ú® PrepPal</h1>
      <p>Your exam preparation assistant ‚Äî chat, quiz, analyze documents.</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div id="welcome" style="text-align:center;color:rgba(255,255,255,0.9);margin-top:10px">
        <h2 style="margin-bottom:6px">Welcome to PrepPal üëã</h2>
        <p style="opacity:0.85">Try quick actions: </p>
        <div style="margin-top:12px" class="quick-actions">
          <div class="quick-action" onclick="quickMode('quiz')">üìã Generate Quiz</div>
          <div class="quick-action" onclick="quickMode('practice')">üß© Practice Questions</div>
          <div class="quick-action" onclick="quickMode('explain')">üß† Explain Concept</div>
          <div class="quick-action" onclick="quickMode('plan')">üìÖ Create Study Plan</div>
          <div class="quick-action" onclick="document.getElementById('fileInput').click()">üìö Upload & Analyze</div>
        </div>
      </div>
    </div>

    <div style="padding:0 20px;">
      <div class="file-preview" id="filePreview"><strong id="fileName"></strong> ‚Äî <span id="fileStatus">waiting</span></div>
    </div>

    <div class="chat-input-container">
      <input id="fileInput" type="file" style="display:none" accept=".pdf,.doc,.docx,.txt" onchange="onFilePicked(event)">
      <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()" title="Upload study materials">üìé Upload</button>

      <textarea id="chatInput" class="chat-input" placeholder="Ask me anything about your studies..." rows="1" oninput="autoHeight(this)" onkeydown="onKeyDown(event)"></textarea>
      <button class="send-btn" id="sendBtn" title="Send" onclick="sendMessage()">Send ‚û§</button>
    </div>
  </div>

<script>
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const statusText = document.getElementById('statusText');
const statusDot = document.getElementById('statusDot');
const filePreview = document.getElementById('filePreview');
const fileNameEl = document.getElementById('fileName');
const fileStatusEl = document.getElementById('fileStatus');

let currentFile = null;

// Helpers
function autoHeight(el){ el.style.height='auto'; el.style.height = Math.min(el.scrollHeight,200)+'px'; }
function onKeyDown(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } }

// Add message
function addMessage(text, sender='bot', docBased=false, sources=[]){
  const div = document.createElement('div');
  div.className = 'message ' + (sender==='user' ? 'user' : 'bot');
  // content
  const inner = document.createElement('div');
  inner.innerHTML = text.replace(/\n/g,'<br>');
  div.appendChild(inner);
  // doc badge if applicable
  if(docBased){
    const badge = document.createElement('div');
    badge.className = 'document-badge';
    badge.textContent = 'üìö Answer uses uploaded material';
    div.appendChild(badge);
    // optionally show sources (first 3)
    if(Array.isArray(sources) && sources.length){
      const list = document.createElement('div');
      list.style.marginTop='8px';
      list.style.fontSize='12px';
      list.style.opacity='0.85';
      list.textContent = 'Sources: ' + sources.slice(0,3).map(s=>s.metadata?.source||s.source||'file').join(', ');
      div.appendChild(list);
    }
  }
  // time meta
  const meta = document.createElement('div');
  meta.className = 'meta';
  const now = new Date();
  meta.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  div.appendChild(meta);

  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Quick mode triggers
function quickMode(mode){
  if(mode==='quiz'){ chatInput.value = 'Generate a 5-question multiple choice quiz based on uploaded materials (if any).'; }
  if(mode==='practice'){ chatInput.value = 'Generate 5 practice questions with answers on the topic: '; }
  if(mode==='explain'){ chatInput.value = 'Explain the concept of '; }
  if(mode==='plan'){ chatInput.value = 'Create a personalized study plan: exam in X days, subjects: '; }
  chatInput.focus();
  autoHeight(chatInput);
}

// Health check
async function checkHealth(){
  try{
    const r = await fetch('/health');
    const j = await r.json();
    const s = j.status || (j.rag_ready ? 'ready' : 'not ready');
    statusText.textContent = s === 'ready' ? 'Ready' : 'Not ready';
    statusDot.style.background = s === 'ready' ? '#22c55e' : '#ef4444';
    statusText.style.opacity = 0.95;
  }catch(e){
    statusText.textContent = 'Server error';
    statusDot.style.background = '#ef4444';
  }
}
checkHealth();

// File upload handler
async function onFilePicked(e){
  const f = e.target.files[0];
  if(!f) return;
  currentFile = f;
  fileNameEl.textContent = f.name;
  fileStatusEl.textContent = 'Uploading...';
  filePreview.style.display = 'block';
  // send to server
  const fd = new FormData();
  fd.append('file', f);
  try{
    const res = await fetch('/upload', { method:'POST', body: fd });
    const j = await res.json();
    if(res.ok){
      fileStatusEl.textContent = 'Indexed';
      addMessage('File uploaded and indexed: ' + f.name, 'bot', true, []);
      checkHealth();
    } else {
      fileStatusEl.textContent = 'Upload failed';
      addMessage('‚ö†Ô∏è Upload failed: ' + (j.error||j.message||res.statusText), 'bot');
    }
  }catch(err){
    fileStatusEl.textContent = 'Upload error';
    addMessage('‚ö†Ô∏è Upload error: '+err.message, 'bot');
  }
}

// Send message (mode detection included)
async function sendMessage(){
  const text = chatInput.value.trim();
  if(!text && !currentFile) return;
  // Show user message
  addMessage(text, 'user');
  chatInput.value=''; autoHeight(chatInput);

  // Determine a 'mode' to hint backend
  let mode = 'default';
  const t = text.toLowerCase();
  if(t.includes('quiz') || t.startsWith('generate a') && t.includes('quiz')) mode = 'quiz';
  else if(t.includes('practice') || t.includes('practice questions')) mode = 'practice';
  else if(t.startsWith('explain') || t.startsWith('explain the') || t.startsWith('what is')) mode = 'explain';
  else if(t.includes('study plan') || t.includes('plan')) mode = 'plan';

  // call backend
  addTypingIndicator();
  try{
    const payload = { query: text, mode };
    const res = await fetch('/chat', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    removeTypingIndicator();
    const reply = j.response || j.answer || 'Sorry, no response.';
    const docBased = !!j.doc_based;
    const sources = j.sources || [];
    addMessage(reply, 'bot', docBased, sources);
    checkHealth();
  }catch(err){
    removeTypingIndicator();
    addMessage('‚ö†Ô∏è Network error: '+err.message, 'bot');
  }
}

// typing indicator UI
let typingEl=null;
function addTypingIndicator(){
  typingEl = document.createElement('div');
  typingEl.className = 'message bot';
  typingEl.innerHTML = '<div style="opacity:0.85">Thinking<span style="opacity:0.6"> . . .</span></div>';
  chatMessages.appendChild(typingEl);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}
function removeTypingIndicator(){
  if(typingEl){ typingEl.remove(); typingEl=null; }
}
</script>
</body>
</html>
